<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#08080c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>College Attendance Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22College%20Attendance%20Tracker%22%2C%22short_name%22%3A%22Attendance%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%2308080c%22%2C%22theme_color%22%3A%22%2308080c%22%7D">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { dark: { 900: '#08080c', 800: '#0e0e14', 700: '#16161f', 600: '#1e1e2a', 500: '#282836' } }
                }
            }
        }
    </script>
    
    <style>
        * { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { background: #08080c; overscroll-behavior: none; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .glass { background: rgba(22, 22, 31, 0.95); border: 1px solid rgba(255,255,255,0.03); backdrop-filter: blur(10px); }
        .glass-hover { transition: all 0.2s; }
        .glass-hover:hover { background: rgba(22, 22, 31, 0.98); border-color: rgba(255,255,255,0.06); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .glow-green { box-shadow: 0 0 12px rgba(16, 185, 129, 0.15); }
        .glow-red { box-shadow: 0 0 12px rgba(239, 68, 68, 0.15); }
        .cal-cell { transition: all 0.15s ease; cursor: pointer; position: relative; }
        .cal-cell:hover { transform: scale(1.08); z-index: 10; }
        .cal-cell:active { transform: scale(0.92); }
        .cal-logged { background: rgba(16, 185, 129, 0.12); border-color: rgba(16, 185, 129, 0.3); }
        .cal-holiday { background: rgba(239, 68, 68, 0.12); border-color: rgba(239, 68, 68, 0.25); }
        .cal-event { background: rgba(139, 92, 246, 0.12); border-color: rgba(139, 92, 246, 0.25); }
        .cal-sunday { background: rgba(251, 191, 36, 0.08); border-color: rgba(251, 191, 36, 0.2); }
        .cal-selected { background: rgba(59, 130, 246, 0.25) !important; border-color: rgba(59, 130, 246, 0.5) !important; box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); }
        .cal-today { box-shadow: inset 0 0 0 2px #3b82f6; }
        .cal-note::after { content: ''; position: absolute; top: 2px; right: 2px; width: 4px; height: 4px; background: #f59e0b; border-radius: 50%; }
        .cal-partial { background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 50%, rgba(239, 68, 68, 0.12) 50%); }
        .status-p { background: linear-gradient(135deg, #10b981, #059669); }
        .status-a { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-c { background: linear-gradient(135deg, #4b5563, #374151); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0); opacity: 1; } 100% { transform: translateY(-100px) rotate(720deg); opacity: 0; } }
        @keyframes ring { 0% { stroke-dashoffset: 251; } }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 5px currentColor; } 50% { box-shadow: 0 0 20px currentColor; } }
        .saving { animation: pulse 1s infinite; }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .slide-up { animation: slideUp 0.4s ease-out; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-ring { animation: ring 1s ease-out forwards; }
        input:-webkit-autofill { -webkit-box-shadow: 0 0 0 1000px #1e1e2a inset !important; -webkit-text-fill-color: #fff !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .btn { transition: all 0.15s; user-select: none; }
        .btn:active { transform: scale(0.95); }
        .stat-card { position: relative; overflow: hidden; transition: all 0.2s; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--glow-color), transparent); }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .progress-ring { transition: stroke-dashoffset 0.8s ease-out; }
        .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-4px); background: rgba(0,0,0,0.95); color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 100; }
        .has-tooltip:hover .tooltip { opacity: 1; }
        .heatmap-cell { transition: all 0.2s; }
        .heatmap-cell:hover { transform: scale(1.15); z-index: 10; }
        .modal-backdrop { backdrop-filter: blur(8px); animation: fadeIn 0.2s ease; }
        .modal-content { animation: slideUp 0.3s ease-out; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 600; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-warning { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge-purple { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        @media print { body { background: white; color: black; } .glass { background: white; border: 1px solid #ddd; } }
        .floating-action { position: fixed; bottom: 80px; right: 16px; z-index: 30; }
        .kbd { padding: 2px 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; font-size: 10px; font-family: monospace; }
        .trend-up::after { content: 'â†—'; color: #10b981; margin-left: 4px; }
        .trend-down::after { content: 'â†˜'; color: #ef4444; margin-left: 4px; }
        .shimmer { background: linear-gradient(90deg, rgba(255,255,255,0.02) 25%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
        .achievement { transition: all 0.3s; }
        .achievement:hover { transform: scale(1.05); }
        .achievement.locked { filter: grayscale(1) opacity(0.5); }
        .achievement.unlocked { animation: glow 2s ease-in-out; }
        .progress-bar { height: 4px; border-radius: 2px; overflow: hidden; background: rgba(255,255,255,0.1); }
        .progress-bar-fill { height: 100%; transition: width 0.5s ease-out; }
        .quick-btn { min-height: 44px; min-width: 44px; }
        .subject-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .nav-item { transition: all 0.2s; }
        .nav-item.active { color: #3b82f6; }
        .nav-item.active::after { content: ''; position: absolute; bottom: -2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: #3b82f6; border-radius: 50%; }
        .pull-indicator { height: 40px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 12px; }
        .skeleton { background: linear-gradient(90deg, #1e1e2a 25%, #282836 50%, #1e1e2a 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        .ring-container { position: relative; display: flex; align-items: center; justify-content: center; }
        .ring-text { position: absolute; text-align: center; }
        .tab-indicator { transition: transform 0.3s ease, width 0.3s ease; }
        .gradient-border { position: relative; }
        .gradient-border::before { content: ''; position: absolute; inset: -1px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border-radius: inherit; z-index: -1; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 0); }
        .extra-class-tag { display: inline-flex; align-items: center; gap: 1px; padding: 2px 5px; background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 4px; font-size: 8px; color: #a78bfa; }
        .subject-card-enhanced { position: relative; overflow: visible; }
        .credit-progress { position: absolute; top: 2px; right: 2px; display: flex; align-items: center; gap: 1px; }
        .credit-dot { width: 4px; height: 4px; border-radius: 50%; background: rgba(255,255,255,0.2); }
        .credit-dot.filled { background: #3b82f6; }
    </style>
</head>
<body class="text-gray-100 min-h-screen" style="opacity: 0; transition: opacity 0.3s;">

    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 modal-backdrop">
        <div class="text-center">
            <div class="w-14 h-14 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-sm text-gray-400" id="loadingText">Initializing...</p>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineBar" class="hidden fixed top-0 left-0 right-0 z-[70] bg-amber-500 text-black text-center py-1 text-xs font-medium">
        You're offline â€¢ Changes will sync when connected
    </div>

    <!-- AUTH -->
    <div id="auth" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-6 w-full max-w-xs modal-content">
            <div class="text-center mb-5">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center shadow-xl">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                </div>
                <h1 class="font-bold text-xl bg-gradient-to-r from-blue-400 to-violet-400 bg-clip-text text-transparent">College Attendance Tracker</h1>
                <p class="text-[11px] text-gray-500 mt-1">Track Your Academic Success</p>
            </div>
            
            <div class="flex mb-4 bg-dark-700 rounded-xl p-1 text-xs relative">
                <div id="tabIndicator" class="tab-indicator absolute top-1 bottom-1 w-1/2 bg-blue-500 rounded-lg"></div>
                <button onclick="authTab('login')" id="tabLogin" class="flex-1 py-2 rounded-lg font-medium relative z-10 transition-colors">Login</button>
                <button onclick="authTab('signup')" id="tabSignup" class="flex-1 py-2 rounded-lg font-medium text-gray-400 relative z-10 transition-colors">Sign Up</button>
            </div>
            
            <form id="formLogin" onsubmit="login(event)" class="space-y-3">
                <div class="relative">
                    <input type="email" id="emailL" required class="w-full px-4 py-3 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 transition-all pl-10" placeholder="Email">
                    <svg class="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                </div>
                <div class="relative">
                    <input type="password" id="passL" required class="w-full px-4 py-3 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 transition-all pl-10" placeholder="Password">
                    <svg class="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <button class="btn w-full py-3 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 font-semibold text-sm shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-shadow">Login</button>
            </form>
            
            <form id="formSignup" onsubmit="signup(event)" class="space-y-3 hidden">
                <div class="relative">
                    <input type="text" id="nameS" required class="w-full px-4 py-3 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 transition-all pl-10" placeholder="Name">
                    <svg class="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </div>
                <div class="relative">
                    <input type="email" id="emailS" required class="w-full px-4 py-3 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 transition-all pl-10" placeholder="Email">
                    <svg class="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                </div>
                <div class="relative">
                    <input type="password" id="passS" required minlength="6" class="w-full px-4 py-3 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500/50 transition-all pl-10" placeholder="Password (min 6)">
                    <svg class="w-4 h-4 absolute left-3.5 top-1/2 -translate-y-1/2 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                </div>
                <button class="btn w-full py-3 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 font-semibold text-sm shadow-lg shadow-blue-500/25 hover:shadow-blue-500/40 transition-shadow">Create Account</button>
            </form>
            
            <p id="authErr" class="text-red-400 text-[11px] mt-3 text-center hidden"></p>
            
            <p class="text-[10px] text-gray-600 text-center mt-4">Your data is securely stored in Firebase</p>
        </div>
    </div>

    <!-- APP -->
    <div id="app" class="hidden min-h-screen pb-24">
        
        <!-- Header -->
        <header class="glass sticky top-0 z-40 px-3 py-2.5 border-b border-white/5 safe-area-top">
            <div class="max-w-lg mx-auto flex items-center justify-between">
                <div class="flex items-center gap-2.5">
                    <button onclick="openProfile()" class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center shadow-lg btn">
                        <span class="text-sm font-bold" id="hdrAvatar">?</span>
                    </button>
                    <div class="leading-tight">
                        <p class="text-sm font-semibold">Attendance Tracker</p>
                        <p class="text-[10px] text-gray-500" id="hdrUser"></p>
                    </div>
                </div>
                <div class="flex gap-0.5">
                    <button onclick="openSearch()" class="p-2 rounded-xl hover:bg-dark-600 btn has-tooltip" title="Search">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        <span class="tooltip">Search</span>
                    </button>
                    <button onclick="openSchedule()" class="p-2 rounded-xl hover:bg-dark-600 btn has-tooltip" title="Schedule">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <span class="tooltip">Schedule</span>
                    </button>
                    <button onclick="openCal()" class="p-2 rounded-xl hover:bg-dark-600 btn has-tooltip" title="Events">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        <span class="tooltip">Events</span>
                    </button>
                    <button onclick="openSemesterManager()" class="p-2 rounded-xl hover:bg-dark-600 btn has-tooltip" title="Semesters">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                        <span class="tooltip">Semesters</span>
                    </button>
                    <button onclick="openSettings()" class="p-2 rounded-xl hover:bg-dark-600 btn has-tooltip" title="Settings">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        <span class="tooltip">Settings</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Quick Stats Bar -->
        <div id="quickStatsBar" class="bg-dark-800 border-b border-white/5 py-2 px-3">
            <div class="max-w-lg mx-auto flex items-center justify-between text-[10px]">
                <div class="flex items-center gap-3">
                    <span class="text-gray-400">Overall: <span id="qsOverall" class="font-bold text-blue-400">--%</span></span>
                    <span class="text-gray-400">Target: <span id="qsTarget" class="font-medium text-violet-400">75%</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="qsStatus" class="badge badge-success">Safe</span>
                    <span id="qsCritical" class="text-gray-500"></span>
                </div>
            </div>
        </div>

        <main class="max-w-lg mx-auto p-3 space-y-3">
            
            <!-- Today's Quick Entry -->
            <div id="todayQuick" class="glass rounded-2xl p-4 slide-in">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <h3 class="text-sm font-semibold">Today's Classes</h3>
                        <p class="text-[10px] text-gray-500" id="todayDate"></p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="todayStatus" class="badge"></span>
                        <button onclick="goToday()" class="p-1.5 rounded-lg bg-dark-600 hover:bg-dark-500 btn">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        </button>
                    </div>
                </div>
                <div id="todayClasses" class="flex flex-wrap gap-1.5"></div>
                <div id="todayEmpty" class="hidden text-center py-3">
                    <p class="text-xl mb-1">ðŸŽ‰</p>
                    <p class="text-[10px] text-gray-500" id="todayEmptyReason">No classes today!</p>
                </div>
                <div id="todayActions" class="hidden mt-3 flex gap-2">
                    <button onclick="quickAllPresent()" class="flex-1 py-2 rounded-lg bg-emerald-500/20 text-emerald-400 text-[10px] font-medium btn hover:bg-emerald-500/30 quick-btn">âœ“ All Present</button>
                    <button onclick="quickAllAbsent()" class="flex-1 py-2 rounded-lg bg-red-500/20 text-red-400 text-[10px] font-medium btn hover:bg-red-500/30 quick-btn">âœ— All Absent</button>
                </div>
            </div>

            <!-- Main Stats with Progress Ring -->
            <div class="glass rounded-2xl p-4 slide-in">
                <div class="flex items-center gap-4">
                    <div class="ring-container">
                        <svg class="w-20 h-20 -rotate-90">
                            <circle cx="40" cy="40" r="35" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="6"/>
                            <circle id="mainRing" cx="40" cy="40" r="35" fill="none" stroke="url(#ringGradient)" stroke-width="6" stroke-linecap="round" class="progress-ring animate-ring" stroke-dasharray="220" stroke-dashoffset="220"/>
                            <defs>
                                <linearGradient id="ringGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#3b82f6"/>
                                    <stop offset="100%" stop-color="#8b5cf6"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="ring-text">
                            <p class="text-lg font-bold" id="ringPct">-</p>
                            <p class="text-[8px] text-gray-500">Overall</p>
                        </div>
                    </div>
                    <div class="flex-1 grid grid-cols-2 gap-2">
                        <div class="bg-dark-700 rounded-xl p-2.5 text-center">
                            <p class="text-base font-bold text-emerald-400" id="sA">-</p>
                            <p class="text-[9px] text-gray-500">Attended</p>
                        </div>
                        <div class="bg-dark-700 rounded-xl p-2.5 text-center">
                            <p class="text-base font-bold text-amber-400" id="sH">-</p>
                            <p class="text-[9px] text-gray-500">Total Held</p>
                        </div>
                        <div class="bg-dark-700 rounded-xl p-2.5 text-center">
                            <p class="text-base font-bold text-red-400" id="sMissed">-</p>
                            <p class="text-[9px] text-gray-500">Missed</p>
                        </div>
                        <div class="bg-dark-700 rounded-xl p-2.5 text-center">
                            <p class="text-base font-bold text-violet-400" id="sS">-</p>
                            <p class="text-[9px] text-gray-500">Progress</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alerts -->
            <div id="alertsBox" class="hidden space-y-2"></div>

            <!-- Calendar -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-3">
                    <button onclick="chgMonth(-1)" class="p-2 rounded-xl hover:bg-dark-600 btn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div class="text-center">
                        <span class="text-sm font-semibold" id="calTitle"></span>
                        <p class="text-[9px] text-gray-500" id="calSubtitle"></p>
                    </div>
                    <button onclick="chgMonth(1)" class="p-2 rounded-xl hover:bg-dark-600 btn">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>
                <div class="grid grid-cols-7 gap-0.5 text-center text-[9px] text-gray-500 mb-2">
                    <span class="text-amber-400 font-semibold">S</span><span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span>
                </div>
                <div id="calGrid" class="grid grid-cols-7 gap-1 mb-2"></div>
                <div class="flex flex-wrap gap-2 text-[9px] text-gray-500">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-emerald-500/20 border border-emerald-500/30"></span>Logged</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-red-500/20 border border-red-500/30"></span>Holiday</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-amber-500/10 border border-amber-500/20"></span>Sunday</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-violet-500/20 border border-violet-500/30"></span>Event</span>
                </div>
            </div>

            <!-- Day Editor -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h3 class="text-sm font-semibold" id="dayTitle">-</h3>
                        <p class="text-[10px] text-gray-500" id="daySub"></p>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openNotes()" id="btnNotes" class="hidden p-2 rounded-xl bg-dark-600 hover:bg-dark-500 btn" title="Note">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                        </button>
                        <button onclick="openAddClass()" id="btnAdd" class="hidden p-2 rounded-xl bg-dark-600 hover:bg-dark-500 btn" title="Edit">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                        </button>
                    </div>
                </div>

                <div id="dayNote" class="hidden mb-2 p-2.5 bg-amber-500/10 border border-amber-500/20 rounded-xl text-[10px] text-amber-200"></div>

                <div id="dayList" class="space-y-1.5"></div>

                <div id="dayEmpty" class="hidden text-center py-6">
                    <p class="text-3xl mb-2">ðŸŽ‰</p>
                    <p class="text-[11px] text-gray-500" id="emptyReason">No classes</p>
                </div>

                <button id="btnSave" onclick="saveDay()" class="hidden w-full mt-3 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-xs font-semibold btn shadow-lg shadow-blue-500/25">
                    Save Changes
                </button>
            </div>

            <!-- MOVED: Subjects (moved here from below) -->
            <div>
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold">ðŸ“š Subjects</h3>
                    <div class="flex gap-2">
                        <select id="subjSort" onchange="renderSubj()" class="text-[10px] px-2 py-1.5 bg-dark-700 border border-dark-600 rounded-lg">
                            <option value="default">Default</option>
                            <option value="pct">By %</option>
                            <option value="name">By Name</option>
                            <option value="classes">By Classes</option>
                            <option value="critical">Critical First</option>
                        </select>
                        <button onclick="toggleSubj()" class="text-[10px] text-blue-400 btn" id="subjToggle">Details</button>
                    </div>
                </div>
                <div id="subjGrid" class="space-y-2"></div>
            </div>

            <!-- Streak & Achievements -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold flex items-center gap-1.5">
                        ðŸ”¥ Streaks & Achievements
                    </h3>
                    <button onclick="openAchievements()" class="text-[10px] text-blue-400 btn">View All</button>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1 bg-dark-700 rounded-xl p-2.5 text-center">
                        <p class="text-xl font-bold text-orange-400" id="curStreak">0</p>
                        <p class="text-[9px] text-gray-500">Current Streak</p>
                    </div>
                    <div class="flex-1 bg-dark-700 rounded-xl p-2.5 text-center">
                        <p class="text-xl font-bold text-violet-400" id="bestStreak">0</p>
                        <p class="text-[9px] text-gray-500">Best Streak</p>
                    </div>
                    <div class="flex-1 bg-dark-700 rounded-xl p-2.5 text-center">
                        <p class="text-xl font-bold text-emerald-400" id="achCount">0</p>
                        <p class="text-[9px] text-gray-500">Achievements</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-5 gap-1.5 slide-in">
                <button onclick="openCalculator()" class="glass rounded-xl p-2.5 text-center glass-hover btn quick-btn">
                    <svg class="w-5 h-5 mx-auto mb-1 text-blue-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                    <span class="text-[9px]">Calc</span>
                </button>
                <button onclick="showBulk()" class="glass rounded-xl p-2.5 text-center glass-hover btn quick-btn">
                    <svg class="w-5 h-5 mx-auto mb-1 text-emerald-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                    <span class="text-[9px]">Bulk</span>
                </button>
                <button onclick="openHeatmap()" class="glass rounded-xl p-2.5 text-center glass-hover btn quick-btn">
                    <svg class="w-5 h-5 mx-auto mb-1 text-amber-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    <span class="text-[9px]">Heat</span>
                </button>
                <button onclick="openWhatIf()" class="glass rounded-xl p-2.5 text-center glass-hover btn quick-btn">
                    <svg class="w-5 h-5 mx-auto mb-1 text-violet-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span class="text-[9px]">What If</span>
                </button>
                <button onclick="openExport()" class="glass rounded-xl p-2.5 text-center glass-hover btn quick-btn">
                    <svg class="w-5 h-5 mx-auto mb-1 text-pink-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span class="text-[9px]">Export</span>
                </button>
            </div>

            <!-- Semester Progress -->
            <div id="semesterProgress" class="hidden glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold">ðŸ“… Semester Progress</h3>
                    <span class="text-[10px] text-gray-500" id="semDaysText"></span>
                </div>
                <div class="progress-bar mb-2">
                    <div id="semProgressBar" class="progress-bar-fill bg-gradient-to-r from-blue-500 to-violet-500"></div>
                </div>
                <div class="flex justify-between text-[10px]">
                    <span class="text-gray-500" id="semStartText"></span>
                    <span class="text-blue-400 font-medium" id="semPctText"></span>
                    <span class="text-gray-500" id="semEndText"></span>
                </div>
            </div>

            <!-- Weekly Trend -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold flex items-center gap-1">
                        ðŸ“ˆ Weekly Trend
                        <span id="trendIndicator" class="badge badge-info"></span>
                    </h3>
                    <span class="text-[10px] text-gray-500" id="weeklyAvg"></span>
                </div>
                <div id="weeklyTrend" class="flex items-end justify-between gap-1 h-16"></div>
                <div class="grid grid-cols-7 gap-1 text-[8px] text-gray-600 mt-1 text-center" id="weeklyLabels"></div>
            </div>

            <!-- Insights -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold flex items-center gap-1">
                        ðŸ“Š Insights
                        <span class="badge badge-info">Live</span>
                    </h3>
                    <button onclick="toggleInsights()" class="text-[10px] text-blue-400 btn" id="insightsToggle">Show</button>
                </div>
                <div id="insightsBox" class="hidden space-y-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-dark-700 rounded-xl p-2.5">
                            <p class="text-[9px] text-gray-500 mb-0.5">Perfect Days</p>
                            <p class="text-sm font-bold text-emerald-400" id="iPerfect">-</p>
                        </div>
                        <div class="bg-dark-700 rounded-xl p-2.5">
                            <p class="text-[9px] text-gray-500 mb-0.5">Working Days</p>
                            <p class="text-sm font-bold text-blue-400" id="iWorkDays">-</p>
                        </div>
                        <div class="bg-dark-700 rounded-xl p-2.5">
                            <p class="text-[9px] text-gray-500 mb-0.5">Classes/Day Avg</p>
                            <p class="text-sm font-bold text-violet-400" id="iAvgDay">-</p>
                        </div>
                        <div class="bg-dark-700 rounded-xl p-2.5">
                            <p class="text-[9px] text-gray-500 mb-0.5">Best Day</p>
                            <p class="text-sm font-bold text-amber-400" id="iBestDay">-</p>
                        </div>
                    </div>
                    <div class="bg-dark-700 rounded-xl p-2.5">
                        <p class="text-[9px] text-gray-500 mb-1">Critical Subjects (below target)</p>
                        <div id="iCritical" class="text-[10px]"></div>
                    </div>
                    <div class="bg-dark-700 rounded-xl p-2.5">
                        <p class="text-[9px] text-gray-500 mb-1">This Week</p>
                        <div id="iWeek" class="text-[10px]"></div>
                    </div>
                    <div class="bg-dark-700 rounded-xl p-2.5">
                        <p class="text-[9px] text-gray-500 mb-1">Attendance by Day</p>
                        <div id="iByDay" class="text-[10px]"></div>
                    </div>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold">ðŸ“† Monthly Summary</h3>
                    <button onclick="toggleMonthly()" class="text-[10px] text-blue-400 btn" id="monthlyToggle">Show</button>
                </div>
                <div id="monthlyBox" class="hidden space-y-2"></div>
            </div>

            <!-- Predictions -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold flex items-center gap-1">
                        ðŸ”® Predictions
                    </h3>
                    <button onclick="togglePred()" class="text-[10px] text-blue-400 btn" id="predToggle">Show</button>
                </div>
                <div id="predBox" class="hidden space-y-2">
                    <p class="text-[10px] text-gray-500">Projected attendance after attending next classes:</p>
                    <div id="predList" class="space-y-1.5"></div>
                </div>
            </div>

            <!-- Semester End Projection -->
            <div class="glass rounded-2xl p-3 glass-hover">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-semibold">ðŸ“ˆ Semester End Projection</h3>
                    <button onclick="toggleProjection()" class="text-[10px] text-blue-400 btn" id="projToggle">Show</button>
                </div>
                <div id="projBox" class="hidden space-y-2">
                    <p class="text-[10px] text-gray-500">Estimated final attendance based on current pattern:</p>
                    <div id="projList" class="space-y-1.5"></div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modals placeholder -->
    <div id="modals"></div>

    <!-- Bottom Navigation (future use) -->
    <nav class="fixed bottom-0 left-0 right-0 z-30 glass border-t border-white/5 px-3 py-2 safe-area-bottom hidden">
        <div class="max-w-lg mx-auto flex items-center justify-around">
            <button class="nav-item p-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            </button>
        </div>
    </nav>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBUkr4IwNbzeG8RkvAx-Y2tKoIDN8sVBsg",
            authDomain: "attendance-tracker-ea7fa.firebaseapp.com",
            projectId: "attendance-tracker-ea7fa",
            storageBucket: "attendance-tracker-ea7fa.firebasestorage.app",
            messagingSenderId: "1040432546162",
            appId: "1:1040432546162:web:8fea5fbfaf6b10e6cbc6e5"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global State
        let userData = {};
        let attendance = {};
        let holidays = {};
        let events = {};
        let notes = {};
        let subjects = [];
        let schedule = {};
        let settings = { target: 75, semStart: '', semEnd: '', autoPresent: true };
        let currentUser = null;
        let selectedDate = new Date();
        let calendarMonth = new Date();
        let showSubjDetails = false;
        let currentSemester = 'sem1';
        let semesters = {};
        
        // Credit thresholds
        const CREDIT_THRESHOLDS = { 1: 1, 2: 9, 3: 27, 4: 36 };
        
        // Initialize app after auth check
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                hideLoading();
                loadUserData();
            } else {
                hideLoading();
                showAuth();
            }
        });
        
        function hideLoading() {
            const loading = document.getElementById('loading');
            loading.classList.add('hidden');
            document.body.style.opacity = '1';
        }
        
        function showAuth() {
            document.getElementById('auth').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
        
        function showApp() {
            document.getElementById('auth').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }
        
        // Auth functions
        function authTab(tab) {
            const indicator = document.getElementById('tabIndicator');
            const loginTab = document.getElementById('tabLogin');
            const signupTab = document.getElementById('tabSignup');
            const loginForm = document.getElementById('formLogin');
            const signupForm = document.getElementById('formSignup');
            
            if (tab === 'login') {
                indicator.style.transform = 'translateX(0)';
                loginTab.classList.remove('text-gray-400');
                signupTab.classList.add('text-gray-400');
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            } else {
                indicator.style.transform = 'translateX(100%)';
                signupTab.classList.remove('text-gray-400');
                loginTab.classList.add('text-gray-400');
                signupForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
            }
        }
        
        async function login(e) {
            e.preventDefault();
            const email = document.getElementById('emailL').value;
            const pass = document.getElementById('passL').value;
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (err) {
                showAuthError(err.message);
            }
        }
        
        async function signup(e) {
            e.preventDefault();
            const name = document.getElementById('nameS').value;
            const email = document.getElementById('emailS').value;
            const pass = document.getElementById('passS').value;
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await cred.user.updateProfile({ displayName: name });
                await db.collection('users').doc(cred.user.uid).set({
                    name, email, created: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (err) {
                showAuthError(err.message);
            }
        }
        
        function showAuthError(msg) {
            const err = document.getElementById('authErr');
            err.textContent = msg;
            err.classList.remove('hidden');
            setTimeout(() => err.classList.add('hidden'), 5000);
        }
        
        async function loadUserData() {
            try {
                document.getElementById('loadingText').textContent = 'Loading your data...';
                
                // Load user doc
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                userData = userDoc.data() || {};
                
                // Load semesters
                const semDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('semesters').get();
                semesters = semDoc.data() || { sem1: { name: 'Semester 1', subjects: [], schedule: {} } };
                
                // Set current semester
                currentSemester = userData.currentSemester || 'sem1';
                if (!semesters[currentSemester]) {
                    currentSemester = Object.keys(semesters)[0] || 'sem1';
                    semesters[currentSemester] = semesters[currentSemester] || { name: 'Semester 1', subjects: [], schedule: {} };
                }
                
                // Load semester-specific data
                subjects = semesters[currentSemester].subjects || [];
                schedule = semesters[currentSemester].schedule || {};
                
                // Load settings
                const settingsDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('settings').get();
                settings = { target: 75, semStart: '', semEnd: '', autoPresent: true, ...settingsDoc.data() };
                
                // Load attendance
                const attDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('attendance').get();
                attendance = attDoc.data() || {};
                
                // Load holidays
                const holDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('holidays').get();
                holidays = holDoc.data() || {};
                
                // Load events
                const evtDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('events').get();
                events = evtDoc.data() || {};
                
                // Load notes
                const notDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('notes').get();
                notes = notDoc.data() || {};
                
                showApp();
                render();
                checkAutoPresent();
            } catch (err) {
                console.error('Load error:', err);
                alert('Error loading data: ' + err.message);
            }
        }
        
        async function saveData() {
            if (!currentUser) return;
            try {
                await db.collection('users').doc(currentUser.uid).collection('data').doc('attendance').set(attendance);
                await db.collection('users').doc(currentUser.uid).collection('data').doc('holidays').set(holidays);
                await db.collection('users').doc(currentUser.uid).collection('data').doc('events').set(events);
                await db.collection('users').doc(currentUser.uid).collection('data').doc('notes').set(notes);
                await db.collection('users').doc(currentUser.uid).collection('data').doc('settings').set(settings);
                
                // Save semester data
                semesters[currentSemester].subjects = subjects;
                semesters[currentSemester].schedule = schedule;
                await db.collection('users').doc(currentUser.uid).collection('data').doc('semesters').set(semesters);
                
                // Save current semester
                await db.collection('users').doc(currentUser.uid).update({ currentSemester });
            } catch (err) {
                console.error('Save error:', err);
            }
        }
        
        // Auto-present functionality
        function checkAutoPresent() {
            if (!settings.autoPresent) return;
            
            const today = dateKey(new Date());
            const yesterday = dateKey(new Date(Date.now() - 86400000));
            
            // Check if yesterday had classes and wasn't marked
            const todayClasses = getTodayClasses(new Date(yesterday + 'T12:00:00'));
            if (todayClasses.length > 0 && !attendance[yesterday]) {
                // Auto-mark all present for yesterday
                const autoAtt = {};
                todayClasses.forEach(cls => {
                    autoAtt[cls.name] = 'P';
                });
                attendance[yesterday] = autoAtt;
                saveData();
            }
        }
        
        function render() {
            renderHeader();
            renderQuickStats();
            renderToday();
            renderMainStats();
            renderCalendar();
            renderDayEditor();
            renderSubj();
            renderStreaks();
            renderWeeklyTrend();
            renderInsights();
        }
        
        function renderHeader() {
            const name = currentUser.displayName || currentUser.email;
            document.getElementById('hdrAvatar').textContent = name[0].toUpperCase();
            document.getElementById('hdrUser').textContent = name;
            document.getElementById('qsTarget').textContent = settings.target + '%';
        }
        
        function renderQuickStats() {
            const stats = calcOverallStats();
            const overall = stats.held > 0 ? ((stats.attended / stats.held) * 100).toFixed(1) : 0;
            document.getElementById('qsOverall').textContent = overall + '%';
            
            const status = document.getElementById('qsStatus');
            if (overall >= settings.target) {
                status.textContent = 'Safe';
                status.className = 'badge badge-success';
            } else if (overall >= settings.target - 5) {
                status.textContent = 'Warning';
                status.className = 'badge badge-warning';
            } else {
                status.textContent = 'Critical';
                status.className = 'badge badge-danger';
            }
            
            const critical = subjects.filter(s => {
                const sStats = calcSubjectStats(s.name);
                const pct = sStats.held > 0 ? (sStats.attended / sStats.held) * 100 : 100;
                return pct < settings.target;
            }).length;
            
            document.getElementById('qsCritical').textContent = critical > 0 ? `${critical} critical` : '';
        }
        
        function renderToday() {
            const today = new Date();
            const key = dateKey(today);
            const day = today.getDay();
            
            document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            
            const todayClasses = getTodayClasses(today);
            const container = document.getElementById('todayClasses');
            const empty = document.getElementById('todayEmpty');
            const actions = document.getElementById('todayActions');
            const status = document.getElementById('todayStatus');
            
            if (todayClasses.length === 0 || day === 0 || holidays[key]) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                actions.classList.add('hidden');
                status.classList.add('hidden');
                
                let reason = 'No classes today!';
                if (day === 0) reason = 'It\'s Sunday!';
                if (holidays[key]) reason = holidays[key];
                document.getElementById('todayEmptyReason').textContent = reason;
            } else {
                container.classList.remove('hidden');
                empty.classList.add('hidden');
                
                const att = attendance[key] || {};
                const marked = Object.keys(att).length;
                
                if (marked === 0) {
                    actions.classList.remove('hidden');
                } else {
                    actions.classList.add('hidden');
                }
                
                // Status badge
                if (marked === todayClasses.length) {
                    const allPresent = todayClasses.every(c => att[c.name] === 'P');
                    status.textContent = allPresent ? '100%' : 'Completed';
                    status.className = allPresent ? 'badge badge-success' : 'badge badge-info';
                    status.classList.remove('hidden');
                } else if (marked > 0) {
                    status.textContent = `${marked}/${todayClasses.length}`;
                    status.className = 'badge badge-warning';
                    status.classList.remove('hidden');
                } else {
                    status.classList.add('hidden');
                }
                
                // Render class buttons
                container.innerHTML = todayClasses.map(cls => {
                    const st = att[cls.name] || '';
                    let btnClass = 'px-3 py-2 rounded-lg text-[10px] font-medium btn border ';
                    let icon = 'â—‹';
                    
                    if (st === 'P') {
                        btnClass += 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30';
                        icon = 'âœ“';
                    } else if (st === 'A') {
                        btnClass += 'bg-red-500/20 text-red-400 border-red-500/30';
                        icon = 'âœ—';
                    } else {
                        btnClass += 'bg-dark-600 text-gray-400 border-dark-500 hover:border-blue-500/30';
                    }
                    
                    return `<button onclick="quickToggleClass('${cls.name}')" class="${btnClass}">
                        ${icon} ${cls.name}
                    </button>`;
                }).join('');
            }
        }
        
        function quickToggleClass(subj) {
            const key = dateKey(new Date());
            if (!attendance[key]) attendance[key] = {};
            
            const current = attendance[key][subj] || '';
            if (current === '') attendance[key][subj] = 'P';
            else if (current === 'P') attendance[key][subj] = 'A';
            else delete attendance[key][subj];
            
            saveData();
            render();
        }
        
        function quickAllPresent() {
            const key = dateKey(new Date());
            const todayClasses = getTodayClasses(new Date());
            attendance[key] = {};
            todayClasses.forEach(cls => {
                attendance[key][cls.name] = 'P';
            });
            saveData();
            render();
        }
        
        function quickAllAbsent() {
            const key = dateKey(new Date());
            const todayClasses = getTodayClasses(new Date());
            attendance[key] = {};
            todayClasses.forEach(cls => {
                attendance[key][cls.name] = 'A';
            });
            saveData();
            render();
        }
        
        function goToday() {
            selectedDate = new Date();
            calendarMonth = new Date();
            render();
        }
        
        function getTodayClasses(date) {
            const day = date.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayKey = dayNames[day];
            return schedule[dayKey] || [];
        }
        
        function renderMainStats() {
            const stats = calcOverallStats();
            const pct = stats.held > 0 ? ((stats.attended / stats.held) * 100).toFixed(1) : 0;
            
            document.getElementById('ringPct').textContent = pct + '%';
            document.getElementById('sA').textContent = stats.attended;
            document.getElementById('sH').textContent = stats.held;
            document.getElementById('sMissed').textContent = stats.held - stats.attended;
            document.getElementById('sS').textContent = subjects.length;
            
            // Animate ring
            const ring = document.getElementById('mainRing');
            const circumference = 220;
            const offset = circumference - (pct / 100) * circumference;
            ring.style.strokeDashoffset = offset;
        }
        
        function calcOverallStats() {
            let attended = 0, held = 0;
            subjects.forEach(s => {
                const stats = calcSubjectStats(s.name);
                attended += stats.attended;
                held += stats.held;
            });
            return { attended, held };
        }
        
        function calcSubjectStats(subj) {
            let attended = 0, held = 0, extraClasses = [];
            Object.keys(attendance).forEach(date => {
                const att = attendance[date];
                if (att[subj]) {
                    held++;
                    if (att[subj] === 'P') attended++;
                    
                    // Check if it's an extra class
                    const d = new Date(date + 'T12:00:00');
                    const classes = getTodayClasses(d);
                    if (!classes.find(c => c.name === subj)) {
                        extraClasses.push(date);
                    }
                }
            });
            return { attended, held, extraClasses };
        }
        
        function renderCalendar() {
            const year = calendarMonth.getFullYear();
            const month = calendarMonth.getMonth();
            
            document.getElementById('calTitle').textContent = calendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = dateKey(new Date());
            const selected = dateKey(selectedDate);
            
            const grid = document.getElementById('calGrid');
            grid.innerHTML = '';
            
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += '<div></div>';
            }
            
            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const key = dateKey(date);
                const dayOfWeek = date.getDay();
                
                let classes = 'cal-cell text-[11px] p-1.5 rounded-lg border border-dark-500 text-center ';
                
                if (key === today) classes += 'cal-today ';
                if (key === selected) classes += 'cal-selected ';
                if (dayOfWeek === 0) classes += 'cal-sunday ';
                if (holidays[key]) classes += 'cal-holiday ';
                if (events[key]) classes += 'cal-event ';
                if (notes[key]) classes += 'cal-note ';
                if (attendance[key]) {
                    const att = attendance[key];
                    const values = Object.values(att);
                    const hasP = values.includes('P');
                    const hasA = values.includes('A');
                    if (hasP && hasA) classes += 'cal-partial ';
                    else if (hasP) classes += 'cal-logged ';
                    else if (hasA) classes += 'cal-logged ';
                }
                
                grid.innerHTML += `<div class="${classes}" onclick="selectDate(new Date(${year}, ${month}, ${d}))">${d}</div>`;
            }
            
            // Subtitle
            const logged = Object.keys(attendance).filter(k => {
                const d = new Date(k + 'T12:00:00');
                return d.getMonth() === month && d.getFullYear() === year;
            }).length;
            document.getElementById('calSubtitle').textContent = `${logged} days logged`;
        }
        
        function chgMonth(delta) {
            calendarMonth = new Date(calendarMonth.getFullYear(), calendarMonth.getMonth() + delta, 1);
            renderCalendar();
        }
        
        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
            renderDayEditor();
        }
        
        function renderDayEditor() {
            const key = dateKey(selectedDate);
            const day = selectedDate.getDay();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            document.getElementById('dayTitle').textContent = dayNames[day];
            document.getElementById('daySub').textContent = selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            const todayClasses = getTodayClasses(selectedDate);
            const container = document.getElementById('dayList');
            const empty = document.getElementById('dayEmpty');
            const btnAdd = document.getElementById('btnAdd');
            const btnNotes = document.getElementById('btnNotes');
            const btnSave = document.getElementById('btnSave');
            const noteBox = document.getElementById('dayNote');
            
            // Show note if exists
            if (notes[key]) {
                noteBox.textContent = notes[key];
                noteBox.classList.remove('hidden');
            } else {
                noteBox.classList.add('hidden');
            }
            
            // Show buttons
            btnNotes.classList.remove('hidden');
            
            if (todayClasses.length === 0 || day === 0 || holidays[key]) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                btnAdd.classList.add('hidden');
                btnSave.classList.add('hidden');
                
                let reason = 'No classes scheduled';
                if (day === 0) reason = 'Sunday - No classes';
                if (holidays[key]) reason = 'Holiday: ' + holidays[key];
                document.getElementById('emptyReason').textContent = reason;
            } else {
                container.classList.remove('hidden');
                empty.classList.add('hidden');
                btnAdd.classList.remove('hidden');
                
                const att = attendance[key] || {};
                
                container.innerHTML = todayClasses.map(cls => {
                    const st = att[cls.name] || '';
                    return `<div class="flex items-center gap-2 p-2.5 bg-dark-700 rounded-xl">
                        <span class="flex-1 text-xs font-medium">${cls.name}</span>
                        <div class="flex gap-1">
                            <button onclick="setStatus('${key}', '${cls.name}', 'P')" class="px-3 py-1.5 rounded-lg text-[10px] font-medium btn ${st === 'P' ? 'status-p text-white' : 'bg-dark-600 text-gray-400'}">P</button>
                            <button onclick="setStatus('${key}', '${cls.name}', 'A')" class="px-3 py-1.5 rounded-lg text-[10px] font-medium btn ${st === 'A' ? 'status-a text-white' : 'bg-dark-600 text-gray-400'}">A</button>
                            <button onclick="setStatus('${key}', '${cls.name}', 'C')" class="px-3 py-1.5 rounded-lg text-[10px] font-medium btn ${st === 'C' ? 'status-c text-white' : 'bg-dark-600 text-gray-400'}">C</button>
                        </div>
                    </div>`;
                }).join('');
                
                btnSave.classList.remove('hidden');
            }
        }
        
        function setStatus(date, subj, status) {
            if (!attendance[date]) attendance[date] = {};
            if (attendance[date][subj] === status) {
                delete attendance[date][subj];
            } else {
                attendance[date][subj] = status;
            }
            renderDayEditor();
            renderToday();
            renderMainStats();
            renderSubj();
        }
        
        function saveDay() {
            saveData();
            render();
            alert('âœ“ Saved!');
        }
        
        function renderSubj() {
            const container = document.getElementById('subjGrid');
            if (subjects.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 col-span-2">No subjects added yet</p>';
                return;
            }
            
            // Sort subjects
            let sorted = [...subjects];
            const sortBy = document.getElementById('subjSort').value;
            if (sortBy === 'pct') {
                sorted.sort((a, b) => {
                    const aStats = calcSubjectStats(a.name);
                    const bStats = calcSubjectStats(b.name);
                    const aPct = aStats.held > 0 ? (aStats.attended / aStats.held) * 100 : 100;
                    const bPct = bStats.held > 0 ? (bStats.attended / bStats.held) * 100 : 100;
                    return aPct - bPct;
                });
            } else if (sortBy === 'name') {
                sorted.sort((a, b) => a.name.localeCompare(b.name));
            } else if (sortBy === 'classes') {
                sorted.sort((a, b) => {
                    const aStats = calcSubjectStats(a.name);
                    const bStats = calcSubjectStats(b.name);
                    return bStats.held - aStats.held;
                });
            } else if (sortBy === 'critical') {
                sorted.sort((a, b) => {
                    const aStats = calcSubjectStats(a.name);
                    const bStats = calcSubjectStats(b.name);
                    const aPct = aStats.held > 0 ? (aStats.attended / aStats.held) * 100 : 100;
                    const bPct = bStats.held > 0 ? (bStats.attended / bStats.held) * 100 : 100;
                    const aCrit = aPct < settings.target;
                    const bCrit = bPct < settings.target;
                    if (aCrit && !bCrit) return -1;
                    if (!aCrit && bCrit) return 1;
                    return aPct - bPct;
                });
            }
            
            container.innerHTML = sorted.map(s => {
                const stats = calcSubjectStats(s.name);
                const pct = stats.held > 0 ? ((stats.attended / stats.held) * 100).toFixed(1) : 100;
                const threshold = CREDIT_THRESHOLDS[s.credits] || 27;
                const needed = Math.max(0, threshold - stats.held);
                const canBunk = Math.floor((stats.attended - 0.75 * stats.held) / 0.75);
                
                let color = 'bg-emerald-500';
                if (pct < settings.target) color = 'bg-red-500';
                else if (pct < settings.target + 5) color = 'bg-amber-500';
                
                // Credit progress dots
                const creditDots = Array(s.credits).fill(0).map((_, i) => {
                    const filled = (stats.held / threshold) * s.credits > i;
                    return `<span class="credit-dot ${filled ? 'filled' : ''}"></span>`;
                }).join('');
                
                return `<div class="glass rounded-xl p-3 glass-hover subject-card-enhanced">
                    <div class="credit-progress">${creditDots}</div>
                    
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex-1">
                            <h4 class="font-semibold text-xs mb-0.5">${s.name}</h4>
                            <div class="flex items-center gap-1.5 text-[9px] text-gray-500">
                                <span>${s.credits} credits</span>
                                <span>â€¢</span>
                                <span>${stats.held}/${threshold}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold ${pct >= settings.target ? 'text-emerald-400' : 'text-red-400'}">${pct}%</p>
                            <p class="text-[9px] text-gray-500">${stats.attended}/${stats.held}</p>
                        </div>
                    </div>
                    
                    <div class="progress-bar mb-2">
                        <div class="progress-bar-fill ${color}" style="width: ${pct}%"></div>
                    </div>
                    
                    ${showSubjDetails ? `
                        <div class="space-y-1.5 text-[10px]">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Need for ${threshold}:</span>
                                <span class="font-medium ${needed > 0 ? 'text-amber-400' : 'text-emerald-400'}">${needed} classes</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Can bunk:</span>
                                <span class="font-medium ${canBunk > 0 ? 'text-emerald-400' : 'text-red-400'}">${Math.max(0, canBunk)} classes</span>
                            </div>
                            ${stats.extraClasses.length > 0 ? `
                                <div class="pt-1 border-t border-white/5">
                                    <span class="text-gray-500">Extra classes:</span>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${stats.extraClasses.map(date => {
                                            const d = new Date(date + 'T12:00:00');
                                            return `<span class="extra-class-tag">${d.getDate()}/${d.getMonth() + 1}</span>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>`;
            }).join('');
        }
        
        function toggleSubj() {
            showSubjDetails = !showSubjDetails;
            document.getElementById('subjToggle').textContent = showSubjDetails ? 'Simple' : 'Details';
            renderSubj();
        }
        
        function renderStreaks() {
            const streaks = calcStreaks();
            document.getElementById('curStreak').textContent = streaks.current;
            document.getElementById('bestStreak').textContent = streaks.best;
            document.getElementById('achCount').textContent = streaks.achievements;
        }
        
        function calcStreaks() {
            const dates = Object.keys(attendance).sort();
            let current = 0, best = 0, temp = 0;
            let lastDate = null;
            
            dates.forEach(date => {
                const d = new Date(date + 'T12:00:00');
                if (lastDate) {
                    const diff = Math.floor((d - lastDate) / 86400000);
                    if (diff === 1) {
                        temp++;
                    } else {
                        best = Math.max(best, temp);
                        temp = 1;
                    }
                } else {
                    temp = 1;
                }
                lastDate = d;
            });
            
            best = Math.max(best, temp);
            
            // Current streak from today
            const today = dateKey(new Date());
            if (dates.includes(today)) {
                let i = dates.length - 1;
                current = 1;
                while (i > 0) {
                    const d1 = new Date(dates[i] + 'T12:00:00');
                    const d2 = new Date(dates[i - 1] + 'T12:00:00');
                    const diff = Math.floor((d1 - d2) / 86400000);
                    if (diff === 1) {
                        current++;
                        i--;
                    } else {
                        break;
                    }
                }
            }
            
            return { current, best, achievements: Math.floor(best / 10) };
        }
        
        function renderWeeklyTrend() {
            const container = document.getElementById('weeklyTrend');
            const labels = document.getElementById('weeklyLabels');
            const avgSpan = document.getElementById('weeklyAvg');
            const indicator = document.getElementById('trendIndicator');
            
            const today = new Date();
            const weekData = [];
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            // Get last 7 days
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const key = dateKey(date);
                const day = date.getDay();
                
                const classes = getTodayClasses(date);
                const att = attendance[key] || {};
                const attended = classes.filter(c => att[c.name] === 'P').length;
                const total = classes.length;
                const pct = total > 0 ? (attended / total) * 100 : 0;
                
                weekData.push({ day: dayNames[day], pct, date: key });
            }
            
            const maxPct = Math.max(...weekData.map(d => d.pct), 1);
            const avg = weekData.reduce((sum, d) => sum + d.pct, 0) / weekData.length;
            
            // Render bars
            container.innerHTML = weekData.map(d => {
                const height = (d.pct / 100) * 100;
                let color = 'bg-emerald-500';
                if (d.pct < 75) color = 'bg-red-500';
                else if (d.pct < 85) color = 'bg-amber-500';
                
                const isToday = d.date === dateKey(today);
                
                return `<div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-full ${color} rounded-t ${isToday ? 'ring-2 ring-blue-500' : ''}" style="height: ${height}%; min-height: 4px;"></div>
                </div>`;
            }).join('');
            
            // Render labels
            labels.innerHTML = weekData.map(d => `<div>${d.day}</div>`).join('');
            
            avgSpan.textContent = `Avg: ${avg.toFixed(0)}%`;
            
            // Trend indicator
            const firstHalf = weekData.slice(0, 3).reduce((sum, d) => sum + d.pct, 0) / 3;
            const secondHalf = weekData.slice(4).reduce((sum, d) => sum + d.pct, 0) / 3;
            
            if (secondHalf > firstHalf + 5) {
                indicator.textContent = 'â†— Rising';
                indicator.className = 'badge badge-success';
            } else if (secondHalf < firstHalf - 5) {
                indicator.textContent = 'â†˜ Falling';
                indicator.className = 'badge badge-danger';
            } else {
                indicator.textContent = 'â†’ Stable';
                indicator.className = 'badge badge-info';
            }
        }
        
        function renderInsights() {
            // Calculate insights
            const dates = Object.keys(attendance);
            const perfectDays = dates.filter(date => {
                const att = attendance[date];
                return Object.values(att).every(v => v === 'P');
            }).length;
            
            const workDays = dates.length;
            const totalClasses = dates.reduce((sum, date) => sum + Object.keys(attendance[date]).length, 0);
            const avgDay = workDays > 0 ? (totalClasses / workDays).toFixed(1) : 0;
            
            // Best day of week
            const dayStats = {};
            dates.forEach(date => {
                const d = new Date(date + 'T12:00:00');
                const day = d.getDay();
                const att = attendance[date];
                const present = Object.values(att).filter(v => v === 'P').length;
                const total = Object.keys(att).length;
                if (!dayStats[day]) dayStats[day] = { present: 0, total: 0 };
                dayStats[day].present += present;
                dayStats[day].total += total;
            });
            
            let bestDay = 'N/A';
            let bestPct = 0;
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            Object.keys(dayStats).forEach(day => {
                const pct = (dayStats[day].present / dayStats[day].total) * 100;
                if (pct > bestPct) {
                    bestPct = pct;
                    bestDay = dayNames[day];
                }
            });
            
            document.getElementById('iPerfect').textContent = perfectDays;
            document.getElementById('iWorkDays').textContent = workDays;
            document.getElementById('iAvgDay').textContent = avgDay;
            document.getElementById('iBestDay').textContent = bestDay;
            
            // Critical subjects
            const critical = subjects.filter(s => {
                const stats = calcSubjectStats(s.name);
                const pct = stats.held > 0 ? (stats.attended / stats.held) * 100 : 100;
                return pct < settings.target;
            });
            
            const critBox = document.getElementById('iCritical');
            if (critical.length === 0) {
                critBox.innerHTML = '<span class="text-emerald-400">None! All subjects above target ðŸŽ‰</span>';
            } else {
                critBox.innerHTML = critical.map(s => {
                    const stats = calcSubjectStats(s.name);
                    const pct = ((stats.attended / stats.held) * 100).toFixed(1);
                    return `<div class="flex justify-between py-1">
                        <span>${s.name}</span>
                        <span class="text-red-400">${pct}%</span>
                    </div>`;
                }).join('');
            }
            
            // This week
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(dateKey(d));
            }
            
            const weekAtt = weekDates.filter(d => attendance[d]).length;
            const weekTotal = weekDates.filter(d => {
                const dt = new Date(d + 'T12:00:00');
                return getTodayClasses(dt).length > 0 && dt.getDay() !== 0;
            }).length;
            
            document.getElementById('iWeek').innerHTML = `<div class="flex justify-between">
                <span>Days logged</span>
                <span class="text-blue-400">${weekAtt}/${weekTotal}</span>
            </div>`;
            
            // By day of week
            const byDayHTML = dayNames.map((name, i) => {
                if (!dayStats[i]) return '';
                const pct = ((dayStats[i].present / dayStats[i].total) * 100).toFixed(0);
                return `<div class="flex justify-between py-0.5">
                    <span>${name}</span>
                    <span class="${pct >= 75 ? 'text-emerald-400' : 'text-red-400'}">${pct}%</span>
                </div>`;
            }).join('');
            document.getElementById('iByDay').innerHTML = byDayHTML || 'No data';
        }
        
        function toggleInsights() {
            const box = document.getElementById('insightsBox');
            const toggle = document.getElementById('insightsToggle');
            if (box.classList.contains('hidden')) {
                box.classList.remove('hidden');
                toggle.textContent = 'Hide';
            } else {
                box.classList.add('hidden');
                toggle.textContent = 'Show';
            }
        }
        
        function toggleMonthly() {
            const box = document.getElementById('monthlyBox');
            const toggle = document.getElementById('monthlyToggle');
            if (box.classList.contains('hidden')) {
                renderMonthly();
                box.classList.remove('hidden');
                toggle.textContent = 'Hide';
            } else {
                box.classList.add('hidden');
                toggle.textContent = 'Show';
            }
        }
        
        function renderMonthly() {
            const container = document.getElementById('monthlyBox');
            const months = {};
            
            Object.keys(attendance).forEach(date => {
                const d = new Date(date + 'T12:00:00');
                const key = d.getFullYear() + '-' + (d.getMonth() + 1);
                if (!months[key]) months[key] = { attended: 0, held: 0, dates: [] };
                
                const att = attendance[date];
                Object.values(att).forEach(v => {
                    months[key].held++;
                    if (v === 'P') months[key].attended++;
                });
                months[key].dates.push(date);
            });
            
            const sorted = Object.keys(months).sort().reverse();
            container.innerHTML = sorted.map(key => {
                const data = months[key];
                const pct = ((data.attended / data.held) * 100).toFixed(1);
                const [year, month] = key.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                return `<div class="bg-dark-700 rounded-xl p-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-medium">${monthName}</span>
                        <span class="text-sm font-bold ${pct >= settings.target ? 'text-emerald-400' : 'text-red-400'}">${pct}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-bar-fill ${pct >= settings.target ? 'bg-emerald-500' : 'bg-red-500'}" style="width: ${pct}%"></div>
                    </div>
                    <div class="flex justify-between text-[9px] text-gray-500 mt-1">
                        <span>${data.attended}/${data.held} classes</span>
                        <span>${data.dates.length} days</span>
                    </div>
                </div>`;
            }).join('');
        }
        
        function togglePred() {
            const box = document.getElementById('predBox');
            const toggle = document.getElementById('predToggle');
            if (box.classList.contains('hidden')) {
                renderPred();
                box.classList.remove('hidden');
                toggle.textContent = 'Hide';
            } else {
                box.classList.add('hidden');
                toggle.textContent = 'Show';
            }
        }
        
        function renderPred() {
            const container = document.getElementById('predList');
            container.innerHTML = subjects.map(s => {
                const stats = calcSubjectStats(s.name);
                const current = stats.held > 0 ? ((stats.attended / stats.held) * 100).toFixed(1) : 0;
                const after = stats.held > 0 ? (((stats.attended + 1) / (stats.held + 1)) * 100).toFixed(1) : 0;
                const change = (after - current).toFixed(1);
                
                return `<div class="bg-dark-700 rounded-xl p-2.5">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-medium">${s.name}</span>
                        <div class="text-xs">
                            <span class="text-gray-500">${current}%</span>
                            <span class="text-gray-600 mx-1">â†’</span>
                            <span class="text-emerald-400">${after}%</span>
                            <span class="text-[9px] text-emerald-400 ml-1">(+${change})</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
        
        function toggleProjection() {
            const box = document.getElementById('projBox');
            const toggle = document.getElementById('projToggle');
            if (box.classList.contains('hidden')) {
                renderProjection();
                box.classList.remove('hidden');
                toggle.textContent = 'Hide';
            } else {
                box.classList.add('hidden');
                toggle.textContent = 'Show';
            }
        }
        
        function renderProjection() {
            if (!settings.semEnd) {
                document.getElementById('projList').innerHTML = '<p class="text-[10px] text-gray-500">Set semester end date in settings</p>';
                return;
            }
            
            const container = document.getElementById('projList');
            const today = new Date();
            const endDate = new Date(settings.semEnd);
            const daysLeft = Math.floor((endDate - today) / 86400000);
            
            container.innerHTML = subjects.map(s => {
                const stats = calcSubjectStats(s.name);
                
                // Estimate remaining classes (assume same pattern)
                const daysLogged = Object.keys(attendance).length;
                const avgClassesPerDay = stats.held / daysLogged;
                const estRemaining = Math.round(avgClassesPerDay * daysLeft);
                
                // Project with 100% attendance
                const projHeld = stats.held + estRemaining;
                const projAttended = stats.attended + estRemaining;
                const projPct = projHeld > 0 ? ((projAttended / projHeld) * 100).toFixed(1) : 0;
                
                return `<div class="bg-dark-700 rounded-xl p-2.5">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-medium">${s.name}</span>
                        <span class="text-sm font-bold ${projPct >= settings.target ? 'text-emerald-400' : 'text-amber-400'}">${projPct}%</span>
                    </div>
                    <div class="text-[9px] text-gray-500">
                        Est. ${projAttended}/${projHeld} classes (${estRemaining} more)
                    </div>
                </div>`;
            }).join('');
        }
        
        // Modal functions
        function openProfile() {
            showModal('Profile', `
                <div class="space-y-3">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-3 rounded-2xl bg-gradient-to-br from-blue-500 to-violet-600 flex items-center justify-center text-2xl font-bold">
                            ${(currentUser.displayName || currentUser.email)[0].toUpperCase()}
                        </div>
                        <p class="font-semibold">${currentUser.displayName || 'User'}</p>
                        <p class="text-xs text-gray-500">${currentUser.email}</p>
                    </div>
                    <div class="bg-dark-700 rounded-xl p-3 space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Current Semester</span>
                            <span>${semesters[currentSemester]?.name || 'Semester 1'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Total Subjects</span>
                            <span>${subjects.length}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Days Logged</span>
                            <span>${Object.keys(attendance).length}</span>
                        </div>
                    </div>
                    <button onclick="logout()" class="w-full py-2.5 rounded-xl bg-red-500/20 text-red-400 text-sm font-medium btn hover:bg-red-500/30">
                        Sign Out
                    </button>
                </div>
            `);
        }
        
        function logout() {
            auth.signOut();
            location.reload();
        }
        
        function openSettings() {
            showModal('Settings', `
                <form onsubmit="saveSettings(event)" class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Target Attendance %</label>
                        <input type="number" id="setTarget" value="${settings.target}" min="0" max="100" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Semester Start</label>
                        <input type="date" id="setSemStart" value="${settings.semStart}" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Semester End</label>
                        <input type="date" id="setSemEnd" value="${settings.semEnd}" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="flex items-center justify-between p-3 bg-dark-700 rounded-xl">
                        <div>
                            <p class="text-xs font-medium">Auto-mark Present</p>
                            <p class="text-[10px] text-gray-500">Automatically mark all present if not logged</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="setAutoPresent" ${settings.autoPresent ? 'checked' : ''} class="sr-only peer">
                            <div class="w-11 h-6 bg-dark-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <button class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">
                        Save Settings
                    </button>
                </form>
            `);
        }
        
        function saveSettings(e) {
            e.preventDefault();
            settings.target = parseInt(document.getElementById('setTarget').value);
            settings.semStart = document.getElementById('setSemStart').value;
            settings.semEnd = document.getElementById('setSemEnd').value;
            settings.autoPresent = document.getElementById('setAutoPresent').checked;
            saveData();
            closeModal();
            render();
        }
        
        function openSchedule() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            const html = `
                <div class="space-y-3">
                    ${days.map((day, i) => {
                        const classes = schedule[day] || [];
                        return `<div class="bg-dark-700 rounded-xl p-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs font-semibold">${dayNames[i]}</span>
                                <button onclick="editDaySchedule('${day}')" class="text-[10px] text-blue-400 btn">Edit</button>
                            </div>
                            <div class="text-[10px] text-gray-500">
                                ${classes.length > 0 ? classes.map(c => c.name).join(', ') : 'No classes'}
                            </div>
                        </div>`;
                    }).join('')}
                    <button onclick="openSubjectManager()" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">
                        Manage Subjects
                    </button>
                </div>
            `;
            
            showModal('Class Schedule', html);
        }
        
        function editDaySchedule(day) {
            const dayNames = { monday: 'Monday', tuesday: 'Tuesday', wednesday: 'Wednesday', thursday: 'Thursday', friday: 'Friday', saturday: 'Saturday' };
            const classes = schedule[day] || [];
            
            const html = `
                <div class="space-y-3">
                    <div id="scheduleList" class="space-y-2">
                        ${classes.map((c, i) => `
                            <div class="flex items-center gap-2 p-2 bg-dark-700 rounded-xl">
                                <span class="flex-1 text-xs">${c.name}</span>
                                <button onclick="removeFromSchedule('${day}', ${i})" class="p-1.5 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex gap-2">
                        <select id="scheduleSubj" class="flex-1 px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                            ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                        <button onclick="addToSchedule('${day}')" class="px-4 py-2 rounded-xl bg-blue-500 text-sm font-medium btn">Add</button>
                    </div>
                </div>
            `;
            
            showModal(dayNames[day] + ' Classes', html);
        }
        
        function addToSchedule(day) {
            const subj = document.getElementById('scheduleSubj').value;
            if (!schedule[day]) schedule[day] = [];
            schedule[day].push({ name: subj });
            saveData();
            editDaySchedule(day);
        }
        
        function removeFromSchedule(day, index) {
            schedule[day].splice(index, 1);
            saveData();
            editDaySchedule(day);
        }
        
        function openSubjectManager() {
            const html = `
                <div class="space-y-3">
                    <div class="space-y-2">
                        ${subjects.map((s, i) => `
                            <div class="flex items-center gap-2 p-3 bg-dark-700 rounded-xl">
                                <div class="flex-1">
                                    <p class="text-xs font-medium">${s.name}</p>
                                    <p class="text-[10px] text-gray-500">${s.credits} credits</p>
                                </div>
                                <button onclick="removeSubject(${i})" class="p-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 btn">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <form onsubmit="addSubject(event)" class="space-y-2">
                        <input type="text" id="subjName" required placeholder="Subject Name" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                        <select id="subjCredits" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                            <option value="1">1 Credit</option>
                            <option value="2">2 Credits</option>
                            <option value="3" selected>3 Credits</option>
                            <option value="4">4 Credits</option>
                        </select>
                        <button class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">
                            Add Subject
                        </button>
                    </form>
                </div>
            `;
            
            showModal('Manage Subjects', html);
        }
        
        function addSubject(e) {
            e.preventDefault();
            const name = document.getElementById('subjName').value;
            const credits = parseInt(document.getElementById('subjCredits').value);
            subjects.push({ name, credits });
            saveData();
            openSubjectManager();
            render();
        }
        
        function removeSubject(index) {
            if (confirm('Delete this subject and all its data?')) {
                const subj = subjects[index];
                subjects.splice(index, 1);
                
                // Remove from schedule
                Object.keys(schedule).forEach(day => {
                    schedule[day] = schedule[day].filter(c => c.name !== subj.name);
                });
                
                // Remove from attendance
                Object.keys(attendance).forEach(date => {
                    delete attendance[date][subj.name];
                });
                
                saveData();
                openSubjectManager();
                render();
            }
        }
        
        function openSemesterManager() {
            const semKeys = Object.keys(semesters);
            const html = `
                <div class="space-y-3">
                    <div class="space-y-2">
                        ${semKeys.map(key => {
                            const sem = semesters[key];
                            const isCurrent = key === currentSemester;
                            return `<div class="flex items-center gap-2 p-3 bg-dark-700 rounded-xl ${isCurrent ? 'ring-2 ring-blue-500' : ''}">
                                <div class="flex-1">
                                    <p class="text-xs font-medium">${sem.name}</p>
                                    <p class="text-[10px] text-gray-500">${sem.subjects?.length || 0} subjects</p>
                                    ${isCurrent ? '<span class="badge badge-info mt-1">Current</span>' : ''}
                                </div>
                                ${!isCurrent ? `<button onclick="switchSemester('${key}')" class="px-3 py-1.5 rounded-lg bg-blue-500/20 text-blue-400 text-[10px] font-medium btn hover:bg-blue-500/30">Switch</button>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                    <form onsubmit="addSemester(event)" class="space-y-2">
                        <input type="text" id="semName" required placeholder="Semester Name (e.g., Semester 2)" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                        <button class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">
                            Add Semester
                        </button>
                    </form>
                </div>
            `;
            
            showModal('Manage Semesters', html);
        }
        
        function addSemester(e) {
            e.preventDefault();
            const name = document.getElementById('semName').value;
            const key = 'sem' + (Object.keys(semesters).length + 1);
            semesters[key] = { name, subjects: [], schedule: {} };
            saveData();
            openSemesterManager();
        }
        
        function switchSemester(key) {
            if (confirm(`Switch to ${semesters[key].name}? This will load different subjects and schedule.`)) {
                currentSemester = key;
                subjects = semesters[key].subjects || [];
                schedule = semesters[key].schedule || {};
                saveData();
                closeModal();
                render();
            }
        }
        
        function openSearch() {
            showModal('Search', '<p class="text-xs text-gray-500">Search feature coming soon...</p>');
        }
        
        function openCal() {
            showModal('Events & Holidays', `
                <div class="space-y-3">
                    <button onclick="addHoliday()" class="w-full py-2.5 rounded-xl bg-red-500/20 text-red-400 text-sm font-medium btn hover:bg-red-500/30">
                        Add Holiday
                    </button>
                    <button onclick="addEvent()" class="w-full py-2.5 rounded-xl bg-violet-500/20 text-violet-400 text-sm font-medium btn hover:bg-violet-500/30">
                        Add Event
                    </button>
                </div>
            `);
        }
        
        function openNotes() {
            const key = dateKey(selectedDate);
            const note = notes[key] || '';
            
            showModal('Add Note', `
                <form onsubmit="saveNote(event)" class="space-y-3">
                    <textarea id="noteText" rows="4" placeholder="Enter note for this day..." class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500 resize-none">${note}</textarea>
                    <div class="flex gap-2">
                        ${note ? '<button type="button" onclick="deleteNote()" class="flex-1 py-2.5 rounded-xl bg-red-500/20 text-red-400 text-sm font-medium btn">Delete</button>' : ''}
                        <button class="flex-1 py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">Save</button>
                    </div>
                </form>
            `);
        }
        
        function saveNote(e) {
            e.preventDefault();
            const key = dateKey(selectedDate);
            const text = document.getElementById('noteText').value.trim();
            if (text) {
                notes[key] = text;
            } else {
                delete notes[key];
            }
            saveData();
            closeModal();
            render();
        }
        
        function deleteNote() {
            const key = dateKey(selectedDate);
            delete notes[key];
            saveData();
            closeModal();
            render();
        }
        
        function openAddClass() {
            showModal('Add Extra Class', `
                <form onsubmit="addExtraClass(event)" class="space-y-3">
                    <select id="extraSubj" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                        ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                    </select>
                    <div class="flex gap-2">
                        <button type="button" onclick="addExtraClass(event, 'P')" class="flex-1 py-2.5 rounded-xl bg-emerald-500/20 text-emerald-400 text-sm font-medium btn">Present</button>
                        <button type="button" onclick="addExtraClass(event, 'A')" class="flex-1 py-2.5 rounded-xl bg-red-500/20 text-red-400 text-sm font-medium btn">Absent</button>
                    </div>
                </form>
            `);
        }
        
        function addExtraClass(e, status) {
            e.preventDefault();
            const subj = document.getElementById('extraSubj').value;
            const key = dateKey(selectedDate);
            if (!attendance[key]) attendance[key] = {};
            attendance[key][subj] = status;
            saveData();
            closeModal();
            render();
        }
        
        function openCalculator() {
            showModal('Attendance Calculator', `
                <div class="space-y-3">
                    <p class="text-xs text-gray-500">Calculate attendance required/allowed</p>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Current Attended</label>
                        <input type="number" id="calcA" min="0" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Current Held</label>
                        <input type="number" id="calcH" min="1" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Target %</label>
                        <input type="number" id="calcT" value="75" min="0" max="100" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                    </div>
                    <button onclick="calculate()" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">Calculate</button>
                    <div id="calcResult" class="hidden bg-dark-700 rounded-xl p-3 text-xs"></div>
                </div>
            `);
        }
        
        function calculate() {
            const a = parseInt(document.getElementById('calcA').value);
            const h = parseInt(document.getElementById('calcH').value);
            const t = parseInt(document.getElementById('calcT').value) / 100;
            
            const needed = Math.ceil((t * h - a) / (1 - t));
            const allowed = Math.floor((a - t * h) / t);
            
            const result = document.getElementById('calcResult');
            result.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-500">Classes to attend:</span>
                        <span class="font-bold text-emerald-400">${Math.max(0, needed)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">Classes you can miss:</span>
                        <span class="font-bold text-amber-400">${Math.max(0, allowed)}</span>
                    </div>
                </div>
            `;
            result.classList.remove('hidden');
        }
        
        function showBulk() {
            showModal('Bulk Operations', `
                <div class="space-y-2">
                    <button onclick="bulkMarkRange()" class="w-full py-2.5 rounded-xl bg-emerald-500/20 text-emerald-400 text-sm font-medium btn hover:bg-emerald-500/30">
                        Mark Date Range
                    </button>
                    <button onclick="bulkClear()" class="w-full py-2.5 rounded-xl bg-red-500/20 text-red-400 text-sm font-medium btn hover:bg-red-500/30">
                        Clear All Data
                    </button>
                </div>
            `);
        }
        
        function bulkMarkRange() {
            showModal('Mark Date Range', `
                <form onsubmit="applyBulkMark(event)" class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Start Date</label>
                        <input type="date" id="bulkStart" required class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">End Date</label>
                        <input type="date" id="bulkEnd" required class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="applyBulkMark(event, 'P')" class="flex-1 py-2.5 rounded-xl bg-emerald-500/20 text-emerald-400 text-sm font-medium btn">All Present</button>
                        <button type="button" onclick="applyBulkMark(event, 'A')" class="flex-1 py-2.5 rounded-xl bg-red-500/20 text-red-400 text-sm font-medium btn">All Absent</button>
                    </div>
                </form>
            `);
        }
        
        function applyBulkMark(e, status) {
            e.preventDefault();
            const start = new Date(document.getElementById('bulkStart').value);
            const end = new Date(document.getElementById('bulkEnd').value);
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const key = dateKey(d);
                const classes = getTodayClasses(d);
                if (classes.length > 0 && d.getDay() !== 0) {
                    if (!attendance[key]) attendance[key] = {};
                    classes.forEach(c => {
                        attendance[key][c.name] = status;
                    });
                }
            }
            
            saveData();
            closeModal();
            render();
        }
        
        function bulkClear() {
            if (confirm('This will delete ALL attendance data! Are you sure?')) {
                attendance = {};
                saveData();
                closeModal();
                render();
            }
        }
        
        function openHeatmap() {
            const today = new Date();
            const weeks = 12;
            const days = [];
            
            for (let i = weeks * 7 - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                days.push(d);
            }
            
            const html = `
                <div class="space-y-2">
                    <p class="text-[10px] text-gray-500 mb-3">Last ${weeks} weeks attendance heatmap</p>
                    <div class="grid grid-cols-7 gap-1">
                        ${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, i) => {
                            const color = i === 0 ? 'text-amber-400' : 'text-gray-500';
                            return `<div class="text-center text-[8px] font-medium ${color}">${d}</div>`;
                        }).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1">
                        ${days.map(d => {
                            const key = dateKey(d);
                            const day = d.getDay();
                            const classes = getTodayClasses(d);
                            const att = attendance[key];
                            
                            let color = 'bg-dark-600';
                            let title = 'No data';
                            
                            if (classes.length > 0 && att) {
                                const present = Object.values(att).filter(v => v === 'P').length;
                                const total = Object.keys(att).length;
                                const pct = total > 0 ? (present / total) * 100 : 0;
                                
                                if (pct === 100) color = 'bg-emerald-500';
                                else if (pct >= 75) color = 'bg-emerald-500/60';
                                else if (pct >= 50) color = 'bg-amber-500/60';
                                else color = 'bg-red-500/60';
                                
                                title = `${d.getDate()}/${d.getMonth() + 1}: ${pct.toFixed(0)}%`;
                            } else if (day === 0) {
                                color = 'bg-amber-500/10';
                                title = 'Sunday';
                            } else if (holidays[key]) {
                                color = 'bg-red-500/20';
                                title = 'Holiday';
                            }
                            
                            return `<div class="heatmap-cell ${color} aspect-square rounded has-tooltip" title="${title}">
                                <span class="tooltip">${title}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            
            showModal('Attendance Heatmap', html);
        }
        
        function openWhatIf() {
            showModal('What-If Scenarios', `
                <div class="space-y-3">
                    <p class="text-xs text-gray-500">Simulate attendance scenarios</p>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Subject</label>
                        <select id="whatIfSubj" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                            ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Attend Next N Classes</label>
                        <input type="number" id="whatIfN" value="5" min="1" max="50" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm">
                    </div>
                    <button onclick="calculateWhatIf()" class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">Calculate</button>
                    <div id="whatIfResult" class="hidden space-y-2"></div>
                </div>
            `);
        }
        
        function calculateWhatIf() {
            const subj = document.getElementById('whatIfSubj').value;
            const n = parseInt(document.getElementById('whatIfN').value);
            
            const stats = calcSubjectStats(subj);
            const current = stats.held > 0 ? ((stats.attended / stats.held) * 100).toFixed(1) : 0;
            
            const scenarios = [
                { name: 'All Present', a: stats.attended + n, h: stats.held + n },
                { name: 'All Absent', a: stats.attended, h: stats.held + n },
                { name: '50% Present', a: stats.attended + Math.floor(n / 2), h: stats.held + n },
                { name: '75% Present', a: stats.attended + Math.floor(n * 0.75), h: stats.held + n }
            ];
            
            const result = document.getElementById('whatIfResult');
            result.innerHTML = scenarios.map(sc => {
                const pct = ((sc.a / sc.h) * 100).toFixed(1);
                const color = pct >= settings.target ? 'text-emerald-400' : 'text-red-400';
                return `<div class="bg-dark-700 rounded-xl p-2.5">
                    <div class="flex justify-between items-center">
                        <span class="text-xs">${sc.name}</span>
                        <span class="text-sm font-bold ${color}">${pct}%</span>
                    </div>
                    <div class="text-[9px] text-gray-500 mt-1">${sc.a}/${sc.h} classes</div>
                </div>`;
            }).join('');
            result.classList.remove('hidden');
        }
        
        function openExport() {
            showModal('Export Data', `
                <div class="space-y-2">
                    <button onclick="exportJSON()" class="w-full py-2.5 rounded-xl bg-blue-500/20 text-blue-400 text-sm font-medium btn hover:bg-blue-500/30">
                        Export as JSON
                    </button>
                    <button onclick="exportCSV()" class="w-full py-2.5 rounded-xl bg-emerald-500/20 text-emerald-400 text-sm font-medium btn hover:bg-emerald-500/30">
                        Export as CSV
                    </button>
                    <button onclick="printReport()" class="w-full py-2.5 rounded-xl bg-violet-500/20 text-violet-400 text-sm font-medium btn hover:bg-violet-500/30">
                        Print Report
                    </button>
                </div>
            `);
        }
        
        function exportJSON() {
            const data = { subjects, schedule, attendance, holidays, events, notes, settings, semesters };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attendance_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportCSV() {
            let csv = 'Date,Subject,Status\n';
            Object.keys(attendance).sort().forEach(date => {
                const att = attendance[date];
                Object.keys(att).forEach(subj => {
                    csv += `${date},${subj},${att[subj]}\n`;
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'attendance_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function printReport() {
            window.print();
        }
        
        function openAchievements() {
            const achievements = [
                { icon: 'ðŸŽ¯', name: 'First Day', desc: 'Log your first day', unlocked: Object.keys(attendance).length > 0 },
                { icon: 'ðŸ“…', name: 'Week Warrior', desc: 'Log 7 consecutive days', unlocked: calcStreaks().best >= 7 },
                { icon: 'ðŸ”¥', name: 'On Fire', desc: '30 day streak', unlocked: calcStreaks().best >= 30 },
                { icon: 'ðŸ’¯', name: 'Perfect Month', desc: '100% attendance for a month', unlocked: checkPerfectMonth() },
                { icon: 'ðŸŽ“', name: 'Scholar', desc: 'Maintain 90%+ overall', unlocked: calcOverallStats().held > 0 && (calcOverallStats().attended / calcOverallStats().held) >= 0.9 },
                { icon: 'â­', name: 'Dedication', desc: '100 days logged', unlocked: Object.keys(attendance).length >= 100 }
            ];
            
            const html = `
                <div class="grid grid-cols-2 gap-2">
                    ${achievements.map(ach => {
                        const locked = ach.unlocked ? '' : 'locked';
                        return `<div class="achievement ${locked} bg-dark-700 rounded-xl p-3 text-center">
                            <div class="text-3xl mb-2">${ach.icon}</div>
                            <p class="text-xs font-semibold mb-1">${ach.name}</p>
                            <p class="text-[9px] text-gray-500">${ach.desc}</p>
                            ${ach.unlocked ? '<span class="badge badge-success mt-2">Unlocked</span>' : '<span class="badge badge-warning mt-2">Locked</span>'}
                        </div>`;
                    }).join('')}
                </div>
            `;
            
            showModal('Achievements', html);
        }
        
        function checkPerfectMonth() {
            const months = {};
            Object.keys(attendance).forEach(date => {
                const d = new Date(date + 'T12:00:00');
                const key = d.getFullYear() + '-' + d.getMonth();
                if (!months[key]) months[key] = { perfect: true };
                
                const att = attendance[date];
                if (!Object.values(att).every(v => v === 'P')) {
                    months[key].perfect = false;
                }
            });
            
            return Object.values(months).some(m => m.perfect);
        }
        
        function addHoliday() {
            showModal('Add Holiday', `
                <form onsubmit="saveHoliday(event)" class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Date</label>
                        <input type="date" id="holDate" required class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Holiday Name</label>
                        <input type="text" id="holName" required placeholder="e.g., Independence Day" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <button class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">
                        Add Holiday
                    </button>
                </form>
            `);
        }
        
        function saveHoliday(e) {
            e.preventDefault();
            const date = document.getElementById('holDate').value;
            const name = document.getElementById('holName').value;
            holidays[date] = name;
            saveData();
            closeModal();
            render();
        }
        
        function addEvent() {
            showModal('Add Event', `
                <form onsubmit="saveEvent(event)" class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Date</label>
                        <input type="date" id="evtDate" required class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1 block">Event Name</label>
                        <input type="text" id="evtName" required placeholder="e.g., Mid-term Exam" class="w-full px-3 py-2 bg-dark-600 border border-dark-500 rounded-xl text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <button class="w-full py-2.5 rounded-xl bg-gradient-to-r from-blue-500 to-violet-600 text-sm font-semibold btn">
                        Add Event
                    </button>
                </form>
            `);
        }
        
        function saveEvent(e) {
            e.preventDefault();
            const date = document.getElementById('evtDate').value;
            const name = document.getElementById('evtName').value;
            events[date] = name;
            saveData();
            closeModal();
            render();
        }
        
        // Modal system
        function showModal(title, content) {
            const modal = `
                <div id="modalBackdrop" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 modal-backdrop" onclick="closeModal(event)">
                    <div class="glass rounded-2xl w-full max-w-md p-4 modal-content" onclick="event.stopPropagation()">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold">${title}</h3>
                            <button onclick="closeModal()" class="p-1.5 rounded-lg hover:bg-dark-600 btn">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div class="max-h-[70vh] overflow-y-auto hide-scroll">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modals').innerHTML = modal;
        }
        
        function closeModal(event) {
            if (!event || event.target.id === 'modalBackdrop') {
                document.getElementById('modals').innerHTML = '';
            }
        }
        
        // Utility functions
        function dateKey(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Network status
        window.addEventListener('online', () => document.getElementById('offlineBar').classList.add('hidden'));
        window.addEventListener('offline', () => document.getElementById('offlineBar').classList.remove('hidden'));
    </script>
</body>
</html>
